<!doctype html>
<html lang="pt-br">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <link rel="stylesheet" href="css/style.css" />
        <title>Admin - Adicionar</title>
    </head>

    <body>
        <style>
            .list-group-item {
                cursor: pointer;
            }

            .list-group-item:hover {
                --bs-text-opacity: 1;
                color: rgba(
                    var(--bs-light-rgb),
                    var(--bs-text-opacity)
                ) !important;
                --bs-bg-opacity: 1;
                background-color: rgba(
                    var(--bs-danger-rgb),
                    var(--bs-bg-opacity)
                ) !important;
                border-radius: var(--bs-border-radius-lg) !important;
            }

            .invisible {
                display: none;
            }

            .price-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .price-name {
                font-weight: bold;
            }

            .price-value {
                color: #28a745;
            }
        </style>
        <main class="container mt-5">
            <h1 class="text-center fw-bold">Adicionar produtos</h1>
            <div class="card p-2">
                <form
                    action="/admin/add"
                    method="post"
                    enctype="multipart/form-data"
                >
                    <div class="form-group">
                        <label for="name">Nome do produto</label>
                        <input
                            class="form-control"
                            id="name"
                            name="name"
                            type="text"
                            required
                        />
                    </div>

                    <!-- Sistema de preços dinâmico -->
                    <div class="form-group">
                        <div class="row my-1 d-flex align-items-center">
                            <div class="col-5">
                                <label for="priceName">Nome do preço</label>
                                <input
                                    class="form-control"
                                    type="text"
                                    id="priceName"
                                    placeholder="Ex: 500ml, Pequeno, Grande"
                                />
                            </div>
                            <div class="col-5">
                                <label for="priceValue">Valor</label>
                                <input
                                    class="form-control"
                                    type="number"
                                    id="priceValue"
                                    min="0"
                                    step="1"
                                    placeholder="1000 = R$ 10,00"
                                />
                            </div>
                            <div class="col-2">
                                <br />
                                <button
                                    id="addPrice"
                                    type="button"
                                    class="btn btn-success my-2"
                                >
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <ul
                            id="priceList"
                            class="list-group list-group-flush ms-3"
                        ></ul>
                    </div>

                    <div class="form-group">
                        <label for="description">Descrição</label>
                        <textarea
                            name="description"
                            id="description"
                            class="form-control"
                            rows="3"
                            required
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <div class="row my-1 d-flex align-items-center">
                            <div class="col-10">
                                <label for="ingredient">Ingredientes</label>
                                <input
                                    class="form-control"
                                    type="text"
                                    id="ingredient"
                                    placeholder="Digite um ingrediente"
                                />
                            </div>
                            <div class="col-auto">
                                <br />
                                <button
                                    id="addIngredient"
                                    type="button"
                                    class="btn btn-success my-2"
                                >
                                    Adicionar
                                </button>
                            </div>
                        </div>

                        <ul
                            id="ingredientList"
                            class="list-group list-group-flush ms-3"
                        ></ul>
                    </div>

                    <div class="form-group">
                        <label for="type">Tipo</label>
                        <select
                            class="form-control"
                            name="type"
                            id="type"
                            required
                        >
                            <option value="boloCaseiro">Bolo caseiro</option>
                            <option value="boloFesta">Bolo de festa</option>
                            <option value="boloPote">Bolo de pote</option>
                            <option value="doce">Doce</option>
                            <option value="bebida">Bebida</option>
                            <option value="recheio">Recheio</option>
                            <option value="novidade">Novidade</option>
                        </select>
                    </div>

                    <div class="form-group my-3">
                        <input
                            class="form-control-file col-4"
                            type="file"
                            id="image"
                            name="image"
                            accept=".jpg"
                            required
                        />

                        <img
                            id="preview"
                            src=""
                            alt="Pré-visualização"
                            class="img-fluid mt-2"
                            style="
                                max-height: 200px;
                                max-width: 200px;
                                display: none;
                            "
                        />
                    </div>

                    <!-- Campos hidden para enviar os dados -->
                    <input
                        type="hidden"
                        name="ingredients"
                        id="ingredientsHidden"
                    />
                    <input type="hidden" name="prices" id="pricesHidden" />
                    <button type="submit" class="btn btn-primary my-3">
                        Adicionar
                    </button>
                </form>
            </div>
        </main>

        <script>
            const priceNameInput = document.getElementById("priceName");
            const priceValueInput = document.getElementById("priceValue");
            const addPriceBtn = document.getElementById("addPrice");
            const priceList = document.getElementById("priceList");
            const pricesHidden = document.getElementById("pricesHidden");

            const ingredientInput = document.getElementById("ingredient");
            const addIngredientBtn = document.getElementById("addIngredient");
            const ingredientList = document.getElementById("ingredientList");
            const ingredientsHidden =
                document.getElementById("ingredientsHidden");

            const imageInput = document.getElementById("image");
            const preview = document.getElementById("preview");
            const typeOfItem = document.getElementById("type");

            let allPrices = {};
            let allIngredients = [];

            function formatPrice(value) {
                return `R$ ${(value / 100).toFixed(2).replace(".", ",")}`;
            }

            addPriceBtn.addEventListener("click", () => {
                const name = priceNameInput.value.trim();
                const value = priceValueInput.value.trim();

                if (name === "" || value === "") {
                    alert("Por favor, preencha ambos os campos de preço!");
                    return;
                }

                const priceValue = parseInt(value);
                if (isNaN(priceValue) || priceValue < 0) {
                    alert("Por favor, insira um valor válido!");
                    return;
                }

                allPrices[name] = priceValue;

                const item = document.createElement("li");
                item.classList.add("list-group-item", "price-item");

                item.innerHTML = `
                    <div>
                        <span class="price-name">${name}</span>:
                        <span class="price-value">${formatPrice(priceValue)}</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-price">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                item.querySelector(".remove-price").addEventListener(
                    "click",
                    () => {
                        removePrice(item, name);
                    },
                );

                priceList.appendChild(item);

                pricesHidden.value = JSON.stringify(allPrices);

                priceNameInput.value = "";
                priceValueInput.value = "";
                priceNameInput.focus();
            });

            function removePrice(item, name) {
                item.remove();

                delete allPrices[name];
                pricesHidden.value = JSON.stringify(allPrices);
            }

            function loadExistingPrices(pricesObj) {
                priceList.innerHTML = "";
                allPrices = pricesObj || {};

                for (const [name, value] of Object.entries(allPrices)) {
                    const item = document.createElement("li");
                    item.classList.add("list-group-item", "price-item");

                    item.innerHTML = `
                        <div>
                            <span class="price-name">${name}</span>:
                            <span class="price-value">${formatPrice(value)}</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-price">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

                    item.querySelector(".remove-price").addEventListener(
                        "click",
                        () => {
                            removePrice(item, name);
                        },
                    );

                    priceList.appendChild(item);
                }

                pricesHidden.value = JSON.stringify(allPrices);
            }

            document.addEventListener("DOMContentLoaded", function () {
                if (typeof existingPrices !== "undefined") {
                    loadExistingPrices(existingPrices);
                } else {
                    pricesHidden.value = JSON.stringify(allPrices);
                }
                ingredientsHidden.value = JSON.stringify(allIngredients);
            });

            // O resto do código permanece igual...
            addIngredientBtn.addEventListener("click", () => {
                const value = ingredientInput.value.trim();
                if (value === "") return;

                allIngredients.push(value);

                const item = document.createElement("li");
                item.textContent = value;
                item.classList.add("list-group-item");
                item.addEventListener("click", () =>
                    removeIngredient(item, value),
                );
                ingredientList.appendChild(item);

                ingredientsHidden.value = JSON.stringify(allIngredients);
                ingredientInput.value = "";
                ingredientInput.focus();
            });

            function removeIngredient(item, value) {
                item.remove();
                allIngredients = allIngredients.filter((i) => i !== value);
                ingredientsHidden.value = JSON.stringify(allIngredients);
            }

            imageInput.addEventListener("change", () => {
                const file = imageInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = () => {
                    preview.src = reader.result;
                    preview.style.display = "block";
                };
                reader.readAsDataURL(file);
            });

            document.addEventListener("DOMContentLoaded", function () {
                pricesHidden.value = JSON.stringify(allPrices);
                ingredientsHidden.value = JSON.stringify(allIngredients);
            });
        </script>
    </body>
</html>
